import LeadDetails from "@/components/LeadDetails";
import { Id } from "@/convex/_generated/dataModel";
import { LeadCard } from "@/components/LeadCard";
import { Button } from "@/components/ui/button";
import { Dialog } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Search } from "lucide-react";
import { useState, useEffect, useRef } from "react";
import { usePaginatedQuery } from "@/convex/react";
import { api } from "@/convex/_generated/dataModel";
import { useUser } from "@/hooks/useUser";
import { useToast } from "@/hooks/useToast";
import { useQueryClient } from "@tanstack/react-query";

export default function Leads() {
  const [searchQuery, setSearchQuery] = useState("");
  const [debouncedSearch, setDebouncedSearch] = useState("");
  const [viewIrrelevant, setViewIrrelevant] = useState(false);
  
  // New filters
  const [statusFilter, setStatusFilter] = useState<string>("all");
  const [sourceFilter, setSourceFilter] = useState<string>("all");

  const { user, title, isAdmin, allUsers, selectedLeadId, isUnassignedView, isCreateOpen, isOverduePopupOpen, isAssignDialogOpen, setIsCreateOpen, setIsOverduePopupOpen, setIsAssignDialogOpen, setSelectedLeadId, handleAssignToSelf, handleAssignToUser } = useUser();
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const ref = useRef(null);

  // Debounce search
  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedSearch(searchQuery);
    }, 500);
    return () => clearTimeout(handler);
  }, [searchQuery]);

  const { 
    results: leads, 
    status, 
    loadMore, 
  } = usePaginatedQuery(
    api.leads.getPaginatedLeads, 
    { 
      filter: viewIrrelevant ? "irrelevant" : filter, 
      userId: user?._id,
      search: debouncedSearch || undefined,
      status: statusFilter !== "all" ? statusFilter : undefined,
      source: sourceFilter !== "all" ? sourceFilter : undefined,
    }, 
    { initialNumItems: 20 }
  );

  return (
    <AppLayout>
      <div className="flex flex-col h-[calc(100vh-8rem)]">
        {/* Overdue Leads Popup */}
        <Dialog open={isOverduePopupOpen} onOpenChange={setIsOverduePopupOpen}>
           {/* ... keep existing code ... */}
        </Dialog>

        <div className="flex flex-col gap-4 mb-6">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold tracking-tight">
                {viewIrrelevant ? "Irrelevant Leads" : title}
              </h1>
              <p className="text-muted-foreground">Manage your leads and communications.</p>
            </div>
            <div className="flex gap-2">
              <Button 
                variant={viewIrrelevant ? "secondary" : "outline"}
                onClick={() => setViewIrrelevant(!viewIrrelevant)}
              >
                {viewIrrelevant ? "Show Active Leads" : "Show Irrelevant Leads"}
              </Button>

              <Dialog open={isCreateOpen} onOpenChange={setIsCreateOpen}>
                 {/* ... keep existing code ... */}
              </Dialog>

              {/* Follow-up Date Assignment Dialog */}
              <Dialog open={isAssignDialogOpen} onOpenChange={setIsAssignDialogOpen}>
                 {/* ... keep existing code ... */}
              </Dialog>
            </div>
          </div>

          {/* Filters Row */}
          <div className="flex gap-2 items-center">
            <Select value={statusFilter} onValueChange={setStatusFilter}>
              <SelectTrigger className="w-[150px]">
                <SelectValue placeholder="Filter Status" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Statuses</SelectItem>
                <SelectItem value="Cold">Cold</SelectItem>
                <SelectItem value="Hot">Hot</SelectItem>
                <SelectItem value="Mature">Mature</SelectItem>
              </SelectContent>
            </Select>

            <Select value={sourceFilter} onValueChange={setSourceFilter}>
              <SelectTrigger className="w-[150px]">
                <SelectValue placeholder="Filter Source" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Sources</SelectItem>
                <SelectItem value="Manual">Manual</SelectItem>
                <SelectItem value="Pharmavends">Pharmavends</SelectItem>
                <SelectItem value="IndiaMART">IndiaMART</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>

        <div className="flex gap-6 flex-1 overflow-hidden">
          {/* Lead List */}
          <div className={`w-full md:w-1/3 flex flex-col gap-4 ${selectedLeadId ? 'hidden md:flex' : 'flex'}`}>
            <div className="relative">
              <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
              <Input
                placeholder="Search leads..."
                className="pl-8"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
              />
            </div>
            <div className="flex-1 overflow-y-auto space-y-2 pr-2">
              {leads?.map((lead) => (
                <LeadCard
                  key={lead._id}
                  lead={lead}
                  isSelected={selectedLeadId === lead._id}
                  isUnassignedView={isUnassignedView}
                  viewIrrelevant={viewIrrelevant}
                  isAdmin={isAdmin}
                  allUsers={allUsers}
                  onSelect={setSelectedLeadId}
                  onAssignToSelf={(id) => handleAssignToSelf(id)}
                  onAssignToUser={(leadId, userId) => handleAssignToUser(leadId, userId)}
                />
              ))}
              
              {/* Loading indicator and infinite scroll trigger */}
              <div ref={ref} className="py-4 flex justify-center">
                {status === "LoadingMore" && (
                  <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
                )}
                {status === "Exhausted" && leads?.length > 0 && (
                  <span className="text-xs text-muted-foreground">No more leads</span>
                )}
                {status === "LoadingFirstPage" && (
                  <Loader2 className="h-8 w-8 animate-spin text-primary" />
                )}
                {status === "Exhausted" && leads?.length === 0 && (
                  <span className="text-sm text-muted-foreground">No leads found</span>
                )}
              </div>
            </div>
          </div>

          {/* Lead Details */}
          {selectedLeadId ? (
            <LeadDetails 
              leadId={selectedLeadId} 
              onClose={() => setSelectedLeadId(null)} 
            />
          ) : (
            <div className="hidden md:flex flex-1 items-center justify-center text-muted-foreground bg-muted/10 rounded-lg border border-dashed">
              Select a lead to view details
            </div>
          )}
        </div>
      </div>
    </AppLayout>
  );
}